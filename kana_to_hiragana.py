"""Katakana to Hiragana converter"""

KATAKANA_TO_HIRAGANA = {
    "ア": "あ",
    "イ": "い",
    "ウ": "う",
    "エ": "え",
    "オ": "お",
    "カ": "か",
    "キ": "き",
    "ク": "く",
    "ケ": "け",
    "コ": "こ",
    "ガ": "が",
    "ギ": "ぎ",
    "グ": "ぐ",
    "ゲ": "げ",
    "ゴ": "ご",
    "キャ": "きゃ",
    "キュ": "きゅ",
    "キョ": "きょ",
    "ギャ": "ぎゃ",
    "ギュ": "ぎゅ",
    "ギョ": "ぎょ",
    "サ": "さ",
    "シ": "し",
    "ス": "す",
    "セ": "せ",
    "ソ": "そ",
    "ザ": "ざ",
    "ジ": "じ",
    "ズ": "ず",
    "ゼ": "ぜ",
    "ゾ": "ぞ",
    "シャ": "しゃ",
    "シュ": "しゅ",
    "ショ": "しょ",
    "ジャ": "じゃ",
    "ジュ": "じゅ",
    "ジョ": "じょ",
    "タ": "た",
    "チ": "ち",
    "ツ": "つ",
    "テ": "て",
    "ト": "と",
    "ダ": "だ",
    "ヂ": "ぢ",
    "ヅ": "づ",
    "デ": "で",
    "ド": "ど",
    "チャ": "ちゃ",
    "チュ": "ちゅ",
    "チョ": "ちょ",
    "ナ": "な",
    "ニ": "に",
    "ヌ": "ぬ",
    "ネ": "ね",
    "ノ": "の",
    "ニャ": "にゃ",
    "ニュ": "にゅ",
    "ニョ": "にょ",
    "ハ": "は",
    "ヒ": "ひ",
    "フ": "ふ",
    "ヘ": "へ",
    "ホ": "ほ",
    "バ": "ば",
    "ビ": "び",
    "ブ": "ぶ",
    "ベ": "べ",
    "ボ": "ぼ",
    "パ": "ぱ",
    "ピ": "ぴ",
    "プ": "ぷ",
    "ペ": "ぺ",
    "ポ": "ぽ",
    "ヒャ": "ひゃ",
    "ヒュ": "ひゅ",
    "ヒョ": "ひょ",
    "ビャ": "びゃ",
    "ビュ": "びゅ",
    "ビョ": "びょ",
    "マ": "ま",
    "ミ": "み",
    "ム": "む",
    "メ": "め",
    "モ": "も",
    "ミャ": "みゃ",
    "ミュ": "みゅ",
    "ミョ": "みょ",
    "ヤ": "や",
    "ユ": "ゆ",
    "ヨ": "よ",
    "ラ": "ら",
    "リ": "り",
    "ル": "る",
    "レ": "れ",
    "ロ": "ろ",
    "リャ": "りゃ",
    "リュ": "りゅ",
    "リョ": "りょ",
    "ワ": "わ",
    "ヲ": "を",
    "ン": "ん",
    "ッ": "っ",
    "ー": "ー",
    "ァ": "ぁ",
    "ィ": "ぃ",
    "ゥ": "ぅ",
    "ェ": "ぇ",
    "ォ": "ぉ",
    "ャ": "ゃ",
    "ュ": "ゅ",
    "ョ": "ょ",
}


def convert_lyrics(text):
    lines = text.split("\n")
    result = []
    for line in lines:
        line = line.strip()
        if line.startswith("[") and line.endswith("]"):
            result.append(line)
        else:
            # Normalize small kana
            line = (
                line.replace("ィ", "い")
                .replace("ェ", "え")
                .replace("ャ", "や")
                .replace("ュ", "ゆ")
                .replace("ョ", "よ")
                .replace("ァ", "あ")
                .replace("ゥ", "う")
                .replace("ォ", "お")
            )

            converted = []
            i = 0
            while i < len(line):
                if i + 1 < len(line) and line[i : i + 2] in KATAKANA_TO_HIRAGANA:
                    converted.append(KATAKANA_TO_HIRAGANA[line[i : i + 2]])
                    i += 2
                else:
                    converted.append(KATAKANA_TO_HIRAGANA.get(line[i], line[i]))
                    i += 1
            result.append("".join(converted))
    return "\n".join(result)
